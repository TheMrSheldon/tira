<template>
  <v-card class="mt-10">
    <v-card-item v-if="loading"><loading :loading="loading"/></v-card-item>
    <v-card-item v-if="!loading && disabled">
    <v-card-text>
      Code submissions are not enabled for this task. Please contact your organizers <a :href="organizer_link">{{organizer}}</a> to enable code submissions.
    </v-card-text>
    </v-card-item>
    <v-card-item v-if="!loading && !disabled">
      <v-card-text v-if="!repo_url">
        <v-form ref="form" v-model="valid">

          <v-row class="d-flex align-center justify-center">
            <v-col cols="6"><v-checkbox v-model="allow_public_repo" label="Allow Public Github Repository (You can change this later. Using a public Github repository has the advantage that Github Actions are free, otherwise, they count towards the bill of organizers.)" /></v-col>
          </v-row>
          <v-row class="d-flex align-center justify-center">
            <v-col cols="6"><v-text-field @keydown.enter.prevent="connectToCodeRepo()" v-model="new_git_account" label="Your GitHub Account" :rules="[v => !!(v && v.length) || 'Please select your GitHub account.']"/></v-col>
          </v-row>
          <v-row class="d-flex align-center justify-center">
            <v-col cols="6"><v-btn block color="primary" :loading="submit_in_progress" @click="connectToCodeRepo()" text="Add Code Repository"/></v-col>
          </v-row>
        </v-form>
      </v-card-text>

      <v-card-text v-if="repo_url">
        <p class="mb-5">Code submissions allow you to automatically create Docker submissions from your GitHub repository via prepared GitHub actions that build, test, and upload your code as Docker image to TIRA. Your github repository is <a :href="http_repo_url" target="_blank">{{repo_url}}</a> owned by <a :href="http_owner_url" target="_blank">{{owner_url}}</a> (please contact this owner if additional accounts need access to this repository). If you have some problems, please do not hesitate to contact your organizers <a :href="organizer_link">{{organizer}}</a>.</p>

        <v-expansion-panels>
          <v-expansion-panel>
            <v-expansion-panel-title>Step 1: Upload your Code to your repository</v-expansion-panel-title>
            <v-expansion-panel-text>
              <p>Your  <a :href="http_repo_url" target="_blank">prepared Github repository</a> already contains all secrets to build and upload your code as Docker image to TIRA and makes it easier for us to help you in case of problems because we can access the code.</p>
              
              <p>If you start from scratch, you can just <a :href="http_repo_url" target="_blank">clone your repository</a>.</p>
              
              <code-snippet title="Merge your existing repository (intended as second upstream)" :code="code_for_merging" expand_message="If you already have a git repository, please merge it with the tira repository that is intended as second remote/upstream."/>
            </v-expansion-panel-text>
          </v-expansion-panel>

          <v-expansion-panel>
            <v-expansion-panel-title>Step 2: Build your Docker image via GitHub Actions</v-expansion-panel-title>
            <v-expansion-panel-text>
              <p>Please go to your <a :href="http_repo_url" target="_blank">prepared Github repository</a> and upload your code to the repository. Upon initialization, your repository contains a jupyter notebook
              <a :href="http_repo_url + '/blob/main/jupyter-notebook-submissions/pyterrier-notebook.ipynb'" target="_blank">Jupyter notebook</a> together with <a :href="http_repo_url +'/tree/main/jupyter-notebook-submissions'" target="_blank">a detailed README on how to submit together with background information</a>.</p>
              
              <p>In short, navigate to "Actions" -> "upload-notebook-submission" in <a :href="http_repo_url" target="_blank">your Github repository</a> and click on "Run workflow" to start the Github action that builds, tests, and uploads your submission.</p>

              <p>You can also watch the <a href="https://conf.fmi.uni-leipzig.de/playback/presentation/2.3/9d654239893aee5d164d92e3b2263ab510249eea-1700482128152" target="_blank">recording of the tutorial</a> from the IR lab in Leipzig from teh 20.11.2023.</p>
            </v-expansion-panel-text>
          </v-expansion-panel>

          <v-expansion-panel>
            <v-expansion-panel-title>Step 3:Execute your Docker image in TIRA</v-expansion-panel-title>
            <v-expansion-panel-text>
              <p>After your Github action was successfull, it prints out the name under which your software was added to TIRA as Docker submission (at the very bottom of the step "Build, test, and upload image" of your Github action). Click on the Docker tab and select your newly added software (maybe reload the page). Select the dataset on which you want to execute your software together with the execution instance (e.g., 1CPU + 10GB of RAM) and click on RUN to start your submission. Admins will review your submission (might take up to one day) and reach out to you in case there are problems with the execution.</p>

              <p>You can also watch the <a href="https://conf.fmi.uni-leipzig.de/playback/presentation/2.3/9d654239893aee5d164d92e3b2263ab510249eea-1700482128152" target="_blank">recording of the tutorial</a> from the IR lab in Leipzig from teh 20.11.2023.</p>
            </v-expansion-panel-text>
          </v-expansion-panel>
        </v-expansion-panels>
      </v-card-text>
    </v-card-item>
  </v-card>
</template>

<script lang="ts">
import { inject } from 'vue'

import {get, post, inject_response, reportError, reportSuccess, get_link_to_organizer} from "@/utils";
import {Loading, CodeSnippet} from '../components'

export default {
  name: "code-submission",
  components: {Loading, CodeSnippet},
  props: ['organizer', 'organizer_id', 'user_id', 'task_id'],
  data() {
    return {
        loading: true,
        new_git_account: '',
        allow_public_repo: true,
        valid: false,
        submit_in_progress: false,
        repo_url: '',
        http_repo_url: '',
        ssh_repo_url: '',
        owner_url: '',
        http_owner_url: '',
        disabled: false
    }
  },
  methods: {
    async connectToCodeRepo() {
      const { valid } = await (this.$refs.form as any).validate()

      if (!valid) {
        return
      }

      this.submit_in_progress = true
      post(inject("REST base URL")+`/api/add_software_submission_git_repository/${this.task_id}/${this.user_id}`, {"external_owner": this.new_git_account, "allow_public_repo": this.allow_public_repo})
        .then(reportSuccess('Your git repository was created.'))
        .then(inject_response(this))
        .catch(reportError("Problem while adding your git repository.", "This might be a short-term hiccup, please try again. We got the following error: "))
        .then(() => {this.submit_in_progress = false})
    },
  },
  beforeMount() {
    get(inject("REST base URL")+`/api/get_software_submission_git_repository/${this.task_id}/${this.user_id}`)
      .then(inject_response(this, {'loading': false}))
      .catch(reportError("Problem loading the data of the task.", "This might be a short-term hiccup, please try again. We got the following error: "))
  },
  computed: {
    organizer_link() {return get_link_to_organizer(this.organizer_id)},
    code_for_merging() {
      return '#Please make first sure that all changes in your repository are committed to your remote.\ngit remote add tira ' + this.ssh_repo_url + '\ngit config pull.rebase true\ngit pull tira main\ngit push tira main'
    }
  }
}
</script>